<%
#Copyright (C) 2010-2020 Sideview LLC.  All Rights Reserved.
%>
<%inherit file="//base.html" />

<%
if view=="_new" :
    action = "create"
else:
    action = "edit_view_props"
 %>


<link type="text/css" href="${canary_static_url_prefix}lib/editor/editor.css" rel="stylesheet" />
<script language="javascript" type="text/javascript" src="${canary_static_url_prefix}lib/jquery/jquery-3.1.0.js"></script>
<script language="javascript" type="text/javascript" src="${canary_static_url_prefix}lib/editor/forms.js"></script>


<script language="javascript" type="text/javascript">
$(document).ready(function() {
    $("#viewParamsForm").submit(function() {
        $("div.fail").remove();
        var payload = getFormValues();
        var csrf_token = $("input[name='splunk_form_key']").val();
        payload.push("splunk_form_key=" + csrf_token);

        var app  = $("input[name='app']").val();
        var view = $("input[name='view']").val();
        var new_view_name = $("input[name='name']").val();


        $.ajaxPrefilter(function(options, originalOptions, jqXHR) {
            if (options['type'] && options['type'].toUpperCase() == 'GET') return;
            jqXHR.setRequestHeader("X-Splunk-Form-Key", csrf_token);
        });

        var editor = parent.getEditor();
        var url = editor.make_url("/splunkd/__raw/sv_view/${app}/${view}/${action}");

        $.ajax({
            type: "POST",
            url: url,
            data: payload.join("&"),
            success: function(response) {
                if (response.success) {
                    //editor.getViewWindow().document.location.reload();
                    //editor.getSchematicWindow().document.location.reload();

                    if (view=="_new") {
                        editor.updateControlWindow(app, new_view_name);
                    } else {
                        editor.success(app, view);
                    }
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                message = jqXHR.responseJSON["message"];
                console.error("WHAT THE");
                editor.fail(message)

            },
            dataType: "json"
        });




        return false;
    });

    $("#viewParamsForm input")
        .focus(function() {
            var editor = parent.getEditor();

            if ($(this).attr("type")=="submit") return true;
            var name = $(this).attr("name");
            var url = ["/custom/sideview_admin_tools/view/describe?"];
            if (name) url.push("param=" + name);
            editor.getDescriptionWindow().document.location = Sideview.utils.make_url(url.join("&"));
        })

});
</script>



<div class="outerWrapper">

<h2>
% if (view=="_new") :
    Create New View
% else :
    <a href="/splunkd/__raw/sv_module/edit?app=${app}&view=${view}">Edit </a>: ${view|h}
% endif
</h2>
<form id="viewParamsForm">
<table class="editorTable" cellspacing="0">
% if view=="_new" :
    <tr>
        <td class="labelCell"><label>name (for URL and filename)</label></td>
        <td>
            <input type="text" name="name" id="name" class="param" value="new_view" />
        </td>
    </tr>
% endif
    <tr>
        <td class="labelCell"><label>label</label></td>
        <td>
            <input type="text" name="label" id="label" class="param" value="${label|h}" />
        </td>
    </tr>
% for i,name in enumerate(viewAttributes):

    <tr>
        <td class="labelCell"><label>${name| h}</label></td>
        <td>
            <input type="text" name="${name}" id="${name}" class="param" value="${viewAttributes[name]|h}" />
        </td>
    </tr>
% endfor
    <tr>
        <td colspan="3" class="buttonCell">
            <input type="hidden" name="splunk_form_key" value="${csrfToken}" />
            <input type="hidden" class="param" name="app" id="app" class="param" value="${app}" />
            <input type="hidden" class="param" name="view" id="view" class="param" value="${view}" />
            <input type="submit" class="submit" label="save"/>
        </td>
    </tr>
</table>
</form>


</div>